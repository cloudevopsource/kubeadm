
# 02.初始化master节点

<!-- TOC -->

- [01.安裝前的準備](#01.安裝前的準備)
    - [在每個節點安裝依賴工具](#在每個節點安裝依賴工具)
    - [安裝及準備ansible(在部署主機安裝ansible控制端)](#安裝及準備ansible(在部署主機安裝ansible控制端))

<!-- /TOC -->

## 创建kubeadm config配置文件 (第一个master节点)


``` bash
cd /stage
rm -f ./kubeadm-config.yaml
cat <<EOF > ./kubeadm-config.yaml
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v1.16.4
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
controlPlaneEndpoint: "127.0.0.1:8443"
networking:
  serviceSubnet: "10.96.0.0/16"
  podSubnet: "10.100.0.1/16"
  dnsDomain: "cluster.local"
EOF
```
## 初始化第一个master节点

+ kubeadm init
``` bash
# 根据您服务器网速的情况，您需要等候 3 - 10 分钟
kubeadm init --config=kubeadm-config.yaml --upload-certs
```
+ 执行结果

``` bash
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of the control-plane node running the following command on each as root:

  kubeadm join 127.0.0.1:8443 --token ziyp1y.zc58k1t6tsnes4dh \
    --discovery-token-ca-cert-hash sha256:63fff70eeb450678753e4a82761f09c864edc73d0b14efd30fff38673b6d7c64 \
    --control-plane --certificate-key 41b2b761f5d0c4a9af1060f1b9edf14b687b6dd572e60289aa4fc150fb62df47

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
"kubeadm init phase upload-certs --upload-certs" to reload certs afterward.

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 127.0.0.1:8443 --token ziyp1y.zc58k1t6tsnes4dh \
    --discovery-token-ca-cert-hash sha256:63fff70eeb450678753e4a82761f09c864edc73d0b14efd30fff38673b6d7c64
```

## 安装 calico 网络插件
``` bash
# 参考文档 https://docs.projectcalico.org/v3.9/getting-started/kubernetes/
cd /stage
rm -f calico-3.9.2.yaml
wget https://kuboard.cn/install-script/calico/calico-3.9.2.yaml
sed -i "s#192\.168\.0\.0/16#10\.100\.0\.1/16#" calico-3.9.2.yaml
kubectl apply -f calico-3.9.2.yaml
```
